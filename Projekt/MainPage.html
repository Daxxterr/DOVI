<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Monitoring stream example</title>
    <style>
        video {
            width: 640px;
            height: 360px;
        }


    </style>

    <script src="http://cdn.dashjs.org/latest/dash.all.min.js"></script>


    <script class="code">
        function init() {
            var video,
                player,
                url = "https://dash.akamaized.net/akamai/bbb_30fps/bbb_30fps.mpd";

            video = document.querySelector("video");
            player = dashjs.MediaPlayer().create();
            player.initialize(video, url, true);
            player.on(dashjs.MediaPlayer.events["PLAYBACK_ENDED"], function () {
                clearInterval(eventPoller);
                clearInterval(bitrateCalculator);
                // tu pridať metódy po skončení videa
                document.getElementById("button1").style.visibility="visible";

                /*
                document.getElementById("bit_calculated").style.visibility="visible";
                document.getElementById("min_qual").style.visibility="visible";
                document.getElementById("q1").style.visibility="visible";
                document.getElementById("q2").style.visibility="visible";
                document.getElementById("avg_qual").style.visibility="visible";
                document.getElementById("max_qual").style.visibility="visible";*/
            });
            var arr = [];
            var bit_arr = [];
            var max =0, min =10;
            var max_res=0;
            var min_res=99999;
            var eventPoller = setInterval(function () {
                var streamInfo = player.getActiveStream().getStreamInfo();
                var dashMetrics = player.getDashMetrics();
                var dashAdapter = player.getDashAdapter();


                if (dashMetrics && streamInfo) {
                    const periodIdx = streamInfo.index;
                    var repSwitch = dashMetrics.getCurrentRepresentationSwitch('video', true);
                    var bufferLevel = dashMetrics.getCurrentBufferLevel('video', true);
                    var bitrate = repSwitch ? Math.round(dashAdapter.getBandwidthForRepresentation(repSwitch.to, periodIdx) / 1000) : NaN;
                    var adaptation = dashAdapter.getAdaptationForType(periodIdx, 'video', streamInfo)
                    var frameRate = adaptation.Representation_asArray.find(function (rep) {
                        return rep.id === repSwitch.to
                    }).frameRate;
                    var quality = player.getQualityFor('video');
                    document.getElementById('bufferLevel').innerText = bufferLevel + " secs";
                    document.getElementById('framerate').innerText = frameRate + " fps";
                    document.getElementById('reportedBitrate').innerText = bitrate + " Kbps";
                    document.getElementById("qual").innerText = quality;


                }
                arr.push(quality);
                bit_arr.push(bitrate);
                console.log(bit_arr);



                var sum =0;
                var avg=0;
                for(var i=0;i<arr.length;i++)
                {
                    sum+=arr[i];
                }
                avg=sum/arr.length;
                avg=Math.round(avg*100)/100;
                document.getElementById("avg_qual").innerText=avg;
                var bit_sum =0;
                var bit_avg = 0;
                for(var i=1;i<bit_arr.length;i++)
                {
                    bit_sum+=bit_arr[i];
                }
                bit_avg = bit_sum/(bit_arr.length);
                console.log(bit_avg);
                document.getElementById("avg_q_res").innerText=bit_avg;
                if(quality>max){max=quality;}
                if(quality<min){min=quality;}
                if(bitrate>max_res){max_res=bitrate;}
                if(bitrate<min_res){min_res=bitrate;}

                if(max_res>13000){
                    document.getElementById("max_q_res").innerText="3840x2160";
                }

                document.getElementById("min_qual").innerText=min;
                document.getElementById("max_qual").innerText=max;
                document.getElementById("min_q_res").innerText=min_res;
               // document.getElementById("max_q_res").innerText=max_res;
            }, 1000);


            if (video.webkitVideoDecodedByteCount !== undefined) {
                var lastDecodedByteCount = 0;
                const bitrateInterval = 5;
                var bitrateCalculator = setInterval(function () {
                    var calculatedBitrate = (((video.webkitVideoDecodedByteCount - lastDecodedByteCount) / 1000) * 8) / bitrateInterval;
                    document.getElementById('calculatedBitrate').innerText = Math.round(calculatedBitrate) + " Kbps";
                    lastDecodedByteCount = video.webkitVideoDecodedByteCount;
                }, bitrateInterval * 1000);
            } else {
                document.getElementById('chrome-only').style.display = "none";
            }



        }
        function doStuff() {
            document.getElementById("bit_calculated").style.visibility="visible";
            document.getElementById("min_qual").style.visibility="visible";
            document.getElementById("q1").style.visibility="visible";
            document.getElementById("q2").style.visibility="visible";
            document.getElementById("avg_qual").style.visibility="visible";
            document.getElementById("max_qual").style.visibility="visible";
            document.getElementById("min_q_res").style.visibility="visible";
            document.getElementById("max_q_res").style.visibility="visible";
            document.getElementById("avg_q_res").style.visibility="visible";
            document.getElementById("q11").style.visibility="visible";
            document.getElementById("q12").style.visibility="visible";
            document.getElementById("bit_log").style.visibility="visible";
            document.getElementById("button1").style.visibility="hidden";

        }
    </script>


</head>
<body>
<div id="container" >
    <div class="video-container" >
        <video data-dashjs-player autoplay controls="true">
        </video>
    </div>
    <div>
        <strong>Reported bit rate:</strong>
        <span id="reportedBitrate"></span>
        <br/>
        <strong>Buffer level:</strong>
        <span id="bufferLevel"></span>
        <div id="chrome-only">
            <strong>Calculated bit rate:</strong>
            <span id="calculatedBitrate"></span>
        </div>
        <strong>Framerate:</strong>
        <span id="framerate"></span>
        <br/>
        <strong>Current bit rate quality:</strong>
        <span id="qual"></span>
        <br/>
        <strong id="bit_calculated" style="visibility: hidden">Bit rate quality (min | avg | max): </strong>
        <span id="min_qual" style="visibility: hidden"></span>
        <span id="q1" style="visibility: hidden"> | </span>
        <span id="avg_qual" style="visibility: hidden"></span>
        <span id="q2" style="visibility: hidden"> | </span>
        <span id="max_qual" style="visibility: hidden"></span>
        <button id="button1" style="visibility: hidden" onclick="doStuff() ">I love it</button>
        <br/>
        <strong id="bit_log" style="visibility: hidden">Resolution quality (min | avg | max): </strong>
        <span id="min_q_res" style="visibility: hidden"></span>
        <span id="q11" style="visibility: hidden"> | </span>
        <span id="avg_q_res" style="visibility: hidden"></span>
        <span id="q12" style="visibility: hidden"> | </span>
        <span id="max_q_res" style="visibility: hidden"></span>

    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        init();
    });
</script>
<script src="../highlighter.js"></script>
</body>
